<!DOCTYPE html>
<head>
  <meta charset="UTF-8">

  <style>

  #joymap-tooltip {
    position: absolute;
    width: 150px;
    padding: 8px;
    font: 12px sans-serif;
    background: rgba(255, 255, 255, .3);
    border: solid 1px yellow;
    /*border-radius: 8px;*/
    pointer-events: none;
    opacity: 0;
  }

  #joymap-tooltip-title{
    text-align: center;
     font-weight: bold;
     font-size: 105%;
      text-shadow:
        -1px -1px 0 white,
        0px -1px 0 white,
        1px -1px 0 white,
        -1px 1px 0 white,
        0px 1px 0 white,
        1px 1px 0 white;
   }
  </style>


</head>

<body>
  <div id='joymap'>
    <div id='joymap-tooltip'></div>
  </div>
  <script src="d3-3.3.3.js"></script>
</body>

<script>
var f = function(str){ return function(obj){ return str ? obj[str] : obj }}
var indexF = function(d, i){ return i }
var compose = function(g, h){ return function(d){ return g(h(d)) }}

var x, y, color, line, years, segmentG, longStaggeredG

d3.json('formatedData.json', function(error, data){
  var longs = data.years[5]
  var threshhold = 10000
  years = data.years.map(function(year){ return year.map(function(longitude, longitudeNum){
    var rv = []
    var i = longitude.length - 2
    var nextSegment = [longitude[i-1]]
    while (i > 0){
      i = i - 1
      if (~data.breaks[longitudeNum].indexOf(i)){
        nextSegment.push(longitude[i])
        rv.push({points: nextSegment.reverse(), index: i})
        nextSegment = []
      }
      nextSegment.push(longitude[i])
    }
    rv.push({points: nextSegment.reverse(), index: 0})
    return rv
  }) })

  var width = 700,
      height = 700

  x = d3.scale.linear()
      .domain([0, longs[0].length - 1])
      .range([0, width])
  y = d3.scale.linear()
      .domain([0, longs.length])
      .range([0, height])

  popHeight = d3.scale.linear()
      .domain([0, .2, d3.max(d3.merge(longs))])
      .range([0, -1, -200])

  var svg = d3.select('#joymap')
    .append('svg')
      .attr({width: width, height: height})

  area = d3.svg.area()
      .x(function(d, i){ return x(i) })
      .y0(function(d){ return popHeight(d) })
      .y1(0)

  line = d3.svg.line()
      .x(function(d, i){ return x(i) })
      .y(function(d){ return popHeight(d) })

  longStaggeredG = svg.selectAll('g')
      .data(years[0]).enter()
    .append('g')
      .attr('transform', function(d, i){ return 'translate(0, ' + y(i) + ')' })


  longStaggeredG.selectAll('.area')
      .data(function(d){ return d }).enter()
    .append('path')
      .classed('area', true)
      .attr('d', compose(area, f('points')))
      .attr('transform', function(d, i){ return 'translate(' + x(d.index) + ',0)' })
      .style('fill', 'white ')

  longStaggeredG.selectAll('.line')
      .data(function(d){ return d }).enter()
    .append('path')
      .classed('line', true)
      .attr('d', compose(line, f('points')))
      .attr('transform', function(d, i){ return 'translate(' + x(d.index) + ',0)' })
      .style('fill', 'rgba(0,0,0,0) ')
      .style('stroke-width', '1px')
      .style('stroke', 'black')
      .style('opacity', function(d){ return d.points[d.points.length - 1] > threshhold ? 1 : .2 })



  var miniHeight = 100,
      miniWidth = 150
      miniX = d3.scale.ordinal()
        .rangeRoundBands([0, miniWidth], .1)
        .domain(d3.range(years.length)),
      miniY = d3.scale.linear()
        .range([miniHeight, 0]) 

  var tooltip = d3.select('#joymap-tooltip')
  tooltip.append('div').attr('id', 'joymap-tooltip-title')

  var miniSvg = tooltip.append('svg').attr({height: miniHeight, width: miniWidth});

  miniSvg.selectAll('text')
      .data(['90', '95', '00', '05', '10', '15']).enter()
    .append('text')
      .text(f())
      .attr('x', function(d, i){ return miniX(i) + miniX.rangeBand()/2; })
      .attr({'y': miniHeight - 5, 'text-anchor': 'middle'})

  miniSvg.selectAll('rect')
      .data(d3.range(6)).enter()
    .append('rect')
      .attr('x', function(d, i){ return miniX(i); })
      .attr({y: 0, height: 10, width: miniX.rangeBand()})

  var boxSize = 10
  var highlightRect = svg.append('rect').attr({height: y(boxSize), width: x(boxSize), opacity: 0, fill: 'yellow'})

  svg.append('rect')
      .attr({height: height, width: width, opacity: 0})
      .on('mousemove', function(){
        var pos = d3.mouse(this)
        var indices = [x.invert(pos[0]), y.invert(Math.max(pos[1] - y(boxSize), 0))].map(Math.round)
        var selectedData = data.years.map(function(year){
          return d3.sum(year.slice(indices[1], boxSize + indices[1]).map(function(d){
            return d3.sum(d.slice(indices[0], boxSize + indices[0])) }))  
        })

        highlightRect
            .attr('opacity', .5)
            .attr('x', x(indices[0]))
            .attr('y', y(indices[1]))
            .style('stroke-width', '5px')

        tooltip.style({opacity: 1, left: d3.event.pageX + x(boxSize) + 'px', top: d3.event.pageY + 'px'})

        tooltip.select('div').text(d3.format(",.0f")(selectedData[currentIndex]))

        tooltip.selectAll('text').style('font-weight', function(d, i){ return i == currentIndex ? 'bold' : 'normal' })

        miniY.domain([0, d3.max(selectedData.concat(1))]);
        tooltip.selectAll('rect').data(selectedData)
            .attr('y', miniY)
            .attr('height', function(d){ return miniHeight - miniY(d); })
            .attr('fill', function(d, i){ return i == currentIndex ? 'rgba(50, 50, 50, .6)' : 'rgba(100, 100, 100, .5)' })
      })
      .on('mouseout', function(){
        highlightRect.attr('opacity', 0)
        tooltip.style('opacity', 0)
      })



  d3.select('#joymap').append('div').style('width', width + 'px').selectAll('span')
      .data([1990, 1995, 2000, 2005, 2010, 2015]).enter()
    .append('div')
      .classed('yearDiv', true)
      .style({'display': 'inline-block', 'width': 100/6 + '%', 'text-align': 'center', 'cursor': 'pointer'})
      .text(f())
      .style('font-weight', function(d, i){ return i ? 'normal' : 'bold' })
      .on('click', function(d, i){
        transition(i)
        d3.select('#joymap').selectAll('.yearDiv').style('font-weight', 'normal')
        d3.select(this).style('font-weight', 'bold')
      });
});

function transition(index){
  currentIndex = index;
  longStaggeredG.data(years[index]).each(function(longData, longitudeNum){
    d3.select(this).selectAll('.area').data(longData);
    d3.select(this).selectAll('.line').data(longData)
  })

  d3.selectAll('.area').attr('d', compose(area, f('points')))
  d3.selectAll('.line').attr('d', compose(line, f('points')))
}
var currentIndex = 0;

// d3.timer(function(){
//   currentIndex = (currentIndex + 1) % 6
//   console.log(currentIndex)
//   transition(currentIndex)
// }, 2000)

</script>